<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Murritos - Sistema de Pedidos</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #e63946;
            --dark-color: #1d3557;
            --light-color: #f1faee;
            --white: #ffffff;
            --black: #000000;
            --gray: #6c757d;
            --light-gray: #f8f9fa;
            --dark-gray: #343a40;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
        }

        body {
            background-color: var(--light-color);
            color: var(--dark-color);
        }

        .admin-login {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .admin-login.show {
            display: flex;
        }

        .login-box {
            background-color: var(--white);
            padding: 2rem;
            border-radius: 8px;
            width: 300px;
            text-align: center;
        }

        .login-box h2 {
            margin-bottom: 1.5rem;
            color: var(--dark-color);
        }

        .login-box input {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 1px solid var(--gray);
            border-radius: 4px;
        }

        .login-box button {
            width: 100%;
            padding: 0.75rem;
            background-color: var(--primary-color);
            color: var(--white);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }

        .login-box button:hover {
            background-color: #c1121f;
        }

        header {
            background-color: var(--white);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo h1 {
            color: var(--primary-color);
            font-weight: 700;
        }

        nav ul {
            display: flex;
            list-style: none;
        }

        nav ul li {
            margin: 0 1rem;
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
        }

        nav ul li i {
            margin-right: 0.5rem;
        }

        nav ul li.active {
            background-color: var(--primary-color);
            color: var(--white);
        }

        .user-info {
            font-weight: 500;
            display: flex;
            align-items: center;
        }

        .user-info.admin {
            color: var(--primary-color);
        }

        .user-role {
            padding: 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            margin-left: 1rem;
            border: 1px solid var(--gray);
        }

        .user-role.waiter {
            background-color: #1e88e5;
            color: white;
            border-color: #1e88e5;
        }

        .user-role.kitchen {
            background-color: #43a047;
            color: white;
            border-color: #43a047;
        }

        main {
            padding: 2rem;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .section-header h2 {
            color: var(--dark-color);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: var(--white);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
        }

        .btn-primary i {
            margin-right: 0.5rem;
        }

        .btn-primary:hover {
            background-color: #c1121f;
        }

        .btn-secondary {
            background-color: var(--gray);
            color: var(--white);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-secondary:hover {
            background-color: var(--dark-gray);
        }

        .order-controls {
            display: flex;
            gap: 2rem;
        }

        .active-orders {
            flex: 1;
            background-color: var(--white);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .order-details {
            flex: 2;
            background-color: var(--white);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            min-height: 500px;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: var(--gray);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .orders-list {
            margin-top: 1rem;
        }

        .order-card {
            background-color: var(--light-gray);
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .order-card:hover {
            background-color: #e9ecef;
        }

        .order-card.active {
            border-left: 4px solid var(--primary-color);
            background-color: #e9ecef;
        }

        .order-card h4 {
            margin-bottom: 0.5rem;
        }

        .order-card p {
            font-size: 0.875rem;
            color: var(--gray);
        }

        .order-items {
            margin-top: 1.5rem;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid #eee;
        }

        .order-item:last-child {
            border-bottom: none;
        }

        .order-item-info {
            flex: 2;
        }

        .order-item-price {
            flex: 1;
            text-align: right;
        }

        .order-item-comments {
            font-size: 0.75rem;
            color: var(--gray);
            margin-top: 0.25rem;
            font-style: italic;
        }

        .order-actions {
            margin-top: 1.5rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .order-total {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 2px solid var(--dark-color);
            text-align: right;
            font-weight: 700;
            font-size: 1.25rem;
        }

        .sales-summary {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .summary-card {
            flex: 1;
            background-color: var(--white);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .summary-card h3 {
            margin-bottom: 1rem;
            color: var(--gray);
            font-size: 1rem;
            font-weight: 500;
        }

        .summary-card p {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .summary-card.total p {
            color: var(--primary-color);
        }

        .time-filters {
            display: flex;
            gap: 0.5rem;
        }

        .btn-filter {
            background-color: var(--light-gray);
            color: var(--dark-color);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-filter.active {
            background-color: var(--primary-color);
            color: var(--white);
        }

        .sales-list {
            background-color: var(--white);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: var(--light-gray);
            font-weight: 500;
        }

        tr:hover {
            background-color: var(--light-gray);
        }

        .menu-sections {
            background-color: var(--white);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .menu-section {
            margin-bottom: 2rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .section-header h3 {
            color: var(--dark-color);
        }

        .section-actions {
            display: flex;
            gap: 0.5rem;
        }

        .menu-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
        }

        .menu-item {
            background-color: var(--light-gray);
            padding: 1rem;
            border-radius: 4px;
        }

        .menu-item h4 {
            margin-bottom: 0.5rem;
        }

        .menu-item p {
            color: var(--primary-color);
            font-weight: 500;
        }

        .item-actions {
            margin-top: 0.5rem;
            display: flex;
            gap: 0.5rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background-color: var(--white);
            padding: 2rem;
            border-radius: 8px;
            width: 100%;
            max-width: 500px;
            position: relative;
        }

        .modal-content.small {
            max-width: 400px;
        }

        .close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        /* Estilos para los botones de estado */
        .btn-status {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            margin-right: 0.5rem;
            transition: all 0.3s;
        }

        .btn-status.pending {
            background-color: #ffc107;
            color: #000;
        }

        .btn-status.preparation {
            background-color: #fd7e14;
            color: #fff;
        }

        .btn-status.ready {
            background-color: #28a745;
            color: #fff;
        }

        .btn-status:hover {
            opacity: 0.9;
        }

        /* Estilos para pantalla de cocina */
        .kitchen-orders {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .kitchen-card {
            background-color: var(--white);
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-left: 4px solid #ffc107;
        }

        .kitchen-card.preparation {
            border-left-color: #fd7e14;
        }

        .kitchen-card.ready {
            border-left-color: #28a745;
        }

        .kitchen-card .order-header {
            border-bottom: 1px solid #eee;
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
        }

        .kitchen-item {
            display: flex;
            gap: 0.5rem;
            padding: 0.5rem 0;
            border-bottom: 1px dashed #eee;
            align-items: center;
        }

        .item-quantity {
            font-weight: bold;
            min-width: 20px;
        }

        .item-comments {
            font-size: 0.8rem;
            color: var(--gray);
            font-style: italic;
            display: block;
            margin-top: 0.2rem;
        }

        .time-ago {
            font-size: 0.8rem;
            color: var(--gray);
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-badge.pending {
            background-color: #ffc107;
            color: #000;
        }

        .status-badge.preparation {
            background-color: #fd7e14;
            color: #fff;
        }

        .status-badge.ready {
            background-color: #28a745;
            color: #fff;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .order-controls {
                flex-direction: column;
            }
            
            header {
                flex-direction: column;
                padding: 1rem;
            }
            
            nav ul {
                margin-top: 1rem;
                flex-wrap: wrap;
                justify-content: center;
            }
        
            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .order-actions {
                flex-direction: column;
            }

            .btn-status {
                width: 100%;
                margin-bottom: 0.5rem;
            }

            .kitchen-orders {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="admin-login" id="adminLogin">
        <div class="login-box">
            <h2>Acceso Administrador</h2>
            <input type="password" id="adminPassword" placeholder="Contraseña">
            <button onclick="checkAdminPassword()">Ingresar</button>
        </div>
    </div>

    <!-- Audio para notificación de nuevos pedidos -->
    <audio id="newOrderSound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3" type="audio/mpeg">
        Tu navegador no soporta el elemento de audio.
    </audio>

    <header>
        <div class="logo">
            <h1>MURRITOS</h1>
        </div>
        <nav>
            <ul>
                <li class="active" data-section="orders"><i class="fas fa-clipboard-list"></i> Pedidos</li>
                <li data-section="kitchen"><i class="fas fa-utensils"></i> Cocina</li>
                <li data-section="sales"><i class="fas fa-chart-line"></i> Ventas</li>
                <li data-section="menu" id="menuTab"><i class="fas fa-utensils"></i> Menú</li>
            </ul>
        </nav>
        <div class="user-info">
            <span id="userType">Mesero</span>
            <select id="userRole" class="user-role waiter">
                <option value="waiter">Mesero</option>
                <option value="kitchen">Cocina</option>
            </select>
        </div>
    </header>

    <main>
        <!-- Sección de Pedidos -->
        <section id="orders" class="section active">
            <div class="section-header">
                <h2>Pedidos</h2>
                <button id="newOrderBtn" class="btn-primary"><i class="fas fa-plus"></i> Nueva Orden</button>
            </div>
            
            <div class="order-controls">
                <div class="active-orders" id="activeOrders">
                    <h3>Órdenes Activas</h3>
                    <div class="orders-list" id="activeOrdersList"></div>
                </div>
                
                <div class="order-details" id="orderDetails">
                    <div class="empty-state">
                        <i class="fas fa-clipboard-list"></i>
                        <p>Selecciona una orden o crea una nueva</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Sección de Cocina -->
        <section id="kitchen" class="section">
            <div class="section-header">
                <h2>Pantalla de Cocina</h2>
                <div class="time-filters">
                    <button class="btn-filter active" data-kitchen-filter="pending">Pendientes</button>
                    <button class="btn-filter" data-kitchen-filter="preparation">En Preparación</button>
                    <button class="btn-filter" data-kitchen-filter="ready">Listos</button>
                </div>
            </div>
            
            <div class="kitchen-orders" id="kitchenOrders">
                <!-- Las órdenes se cargarán aquí -->
            </div>
        </section>

        <!-- Sección de Ventas -->
        <section id="sales" class="section">
            <div class="section-header">
                <h2>Ventas</h2>
                <div class="time-filters">
                    <button class="btn-filter active" data-filter="day">Hoy</button>
                    <button class="btn-filter" data-filter="week">Esta Semana</button>
                    <button class="btn-filter" data-filter="month">Este Mes</button>
                </div>
            </div>
            
            <div class="sales-summary">
                <div class="summary-card total">
                    <h3>Total Vendido</h3>
                    <p id="totalSales">$0.00</p>
                </div>
                <div class="summary-card orders">
                    <h3>Órdenes</h3>
                    <p id="totalOrders">0</p>
                </div>
            </div>
            
            <div class="sales-list">
                <h3>Historial de Ventas</h3>
                <table id="salesTable">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Mesa</th>
                            <th>Items</th>
                            <th>Total</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="salesList">
                        <!-- Las ventas se cargarán aquí -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Sección de Menú -->
        <section id="menu" class="section">
            <div class="section-header">
                <h2>Administrar Menú</h2>
                <div class="admin-controls">
                    <button id="addSectionBtn" class="btn-primary"><i class="fas fa-plus"></i> Agregar Sección</button>
                </div>
            </div>
            
            <div class="menu-sections" id="menuSections">
                <!-- Las secciones del menú se cargarán aquí -->
            </div>
        </section>
    </main>

    <!-- Modales -->
    <div class="modal" id="newOrderModal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Nueva Orden</h2>
            <div class="form-group">
                <label for="tableName">Nombre de la Mesa:</label>
                <input type="text" id="tableName" placeholder="Ej. Mesa 1, Barra 2, etc.">
            </div>
            <button id="createOrderBtn" class="btn-primary">Crear Orden</button>
        </div>
    </div>

    <div class="modal" id="addItemModal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Agregar Item</h2>
            <div class="form-group">
                <label for="itemSection">Sección:</label>
                <select id="itemSection"></select>
            </div>
            <div class="form-group">
                <label for="itemSelect">Item:</label>
                <select id="itemSelect"></select>
            </div>
            <div class="form-group">
                <label for="itemQuantity">Cantidad:</label>
                <input type="number" id="itemQuantity" min="1" value="1">
            </div>
            <div class="form-group">
                <label for="itemComments">Comentarios:</label>
                <textarea id="itemComments" rows="2"></textarea>
            </div>
            <button id="addItemToOrderBtn" class="btn-primary">Agregar a Orden</button>
        </div>
    </div>

    <div class="modal" id="closeOrderModal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Cerrar Orden</h2>
            <div class="order-summary" id="closeOrderSummary"></div>
            <div class="form-group">
                <label for="finalComments">Comentarios Finales:</label>
                <textarea id="finalComments" rows="3"></textarea>
            </div>
            <button id="confirmCloseOrderBtn" class="btn-primary">Confirmar Cierre</button>
        </div>
    </div>

    <div class="modal" id="sectionModal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="sectionModalTitle">Nueva Sección</h2>
            <div class="form-group">
                <label for="sectionName">Nombre de la Sección:</label>
                <input type="text" id="sectionName" placeholder="Ej. Entradas, Platos Fuertes, etc.">
            </div>
            <button id="saveSectionBtn" class="btn-primary">Guardar</button>
        </div>
    </div>

    <div class="modal" id="itemModal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="itemModalTitle">Nuevo Item</h2>
            <div class="form-group">
                <label for="itemName">Nombre del Item:</label>
                <input type="text" id="itemName" placeholder="Ej. Burrito de Carnitas, etc.">
            </div>
            <div class="form-group">
                <label for="itemPrice">Precio:</label>
                <input type="number" id="itemPrice" min="0" step="0.01" placeholder="0.00">
            </div>
            <button id="saveItemBtn" class="btn-primary">Guardar</button>
        </div>
    </div>

    <div class="modal" id="confirmModal">
        <div class="modal-content small">
            <h2 id="confirmModalTitle">Confirmar</h2>
            <p id="confirmModalMessage">¿Estás seguro que deseas realizar esta acción?</p>
            <div class="modal-buttons">
                <button id="confirmModalCancel" class="btn-secondary">Cancelar</button>
                <button id="confirmModalConfirm" class="btn-primary">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC70WGYyyvUVyK_d_haRQKQSXyoroNrx2w",
            authDomain: "murritos-3640e.firebaseapp.com",
            databaseURL: "https://murritos-3640e-default-rtdb.firebaseio.com",
            projectId: "murritos-3640e",
            storageBucket: "murritos-3640e.appspot.com",
            messagingSenderId: "286299522702",
            appId: "1:286299522702:web:9eacfa403ff6bcf78aabdf"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Variables globales
        let isAdmin = false;
        let currentOrderId = null;
        let currentSectionId = null;
        let currentItemId = null;
        let currentFilter = 'day';
        let lastOrderCount = 0;
        let currentUserRole = 'waiter'; // 'waiter' o 'kitchen'
        const newOrderSound = document.getElementById('newOrderSound');

        // Inicialización de la aplicación
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar si hay un admin logueado
            checkAdminSession();
            
            // Configurar event listeners
            setupEventListeners();
            
            // Cargar datos iniciales según el rol del usuario
            loadInitialData();
            
            // Configurar el selector de rol
            setupRoleSelector();
        });

        // Configurar event listeners
        function setupEventListeners() {
            // Navegación entre secciones
            document.querySelectorAll('nav ul li').forEach(item => {
                item.addEventListener('click', function() {
                    // Remover clase active de todos los items
                    document.querySelectorAll('nav ul li').forEach(li => {
                        li.classList.remove('active');
                    });
                    
                    // Agregar clase active al item clickeado
                    this.classList.add('active');
                    
                    // Ocultar todas las secciones
                    document.querySelectorAll('.section').forEach(section => {
                        section.classList.remove('active');
                    });
                    
                    // Mostrar la sección correspondiente
                    const sectionId = this.getAttribute('data-section');
                    document.getElementById(sectionId).classList.add('active');
                    
                    // Si es la sección de cocina, cargar las órdenes pendientes
                    if (sectionId === 'kitchen') {
                        loadKitchenOrders('pending');
                    }
                });
            });
            
            // Botón nueva orden
            document.getElementById('newOrderBtn').addEventListener('click', openNewOrderModal);
            
            // Botón crear orden
            document.getElementById('createOrderBtn').addEventListener('click', createNewOrder);
            
            // Botón agregar item a orden
            document.getElementById('addItemToOrderBtn').addEventListener('click', addItemToOrder);
            
            // Botón confirmar cierre de orden
            document.getElementById('confirmCloseOrderBtn').addEventListener('click', closeOrder);
            
            // Botón agregar sección
            document.getElementById('addSectionBtn').addEventListener('click', openSectionModal);
            
            // Botón guardar sección
            document.getElementById('saveSectionBtn').addEventListener('click', saveSection);
            
            // Botón guardar item
            document.getElementById('saveItemBtn').addEventListener('click', saveItem);
            
            // Filtros de ventas
            document.querySelectorAll('.btn-filter').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentFilter = this.getAttribute('data-filter');
                    loadSalesData();
                });
            });
            
            // Filtros de cocina
            document.querySelectorAll('[data-kitchen-filter]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('[data-kitchen-filter]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    const filter = this.getAttribute('data-kitchen-filter');
                    loadKitchenOrders(filter);
                });
            });
            
            // Cerrar modales
            document.querySelectorAll('.close').forEach(closeBtn => {
                closeBtn.addEventListener('click', function() {
                    this.closest('.modal').classList.remove('show');
                });
            });
            
            // Cerrar modales al hacer clic fuera
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.remove('show');
                    }
                });
            });
        }

        // Configurar el selector de rol
        function setupRoleSelector() {
            const roleSelector = document.getElementById('userRole');
            
            roleSelector.addEventListener('change', function() {
                currentUserRole = this.value;
                this.className = `user-role ${currentUserRole}`;
                
                // Actualizar la interfaz según el rol
                updateUIForRole();
                
                // Cargar datos según el rol
                loadInitialData();
            });
        }

        // Actualizar la interfaz según el rol
        function updateUIForRole() {
            // Ocultar/mostrar elementos según el rol
            if (currentUserRole === 'kitchen') {
                document.querySelector('nav ul li[data-section="kitchen"]').click();
                document.getElementById('newOrderBtn').classList.add('hidden');
            } else {
                document.querySelector('nav ul li[data-section="orders"]').click();
                document.getElementById('newOrderBtn').classList.remove('hidden');
            }
        }

        // Cargar datos iniciales según el rol
        function loadInitialData() {
            if (currentUserRole === 'kitchen') {
                loadKitchenOrders('pending');
            } else {
                loadActiveOrders();
                loadSalesData();
            }
            
            if (isAdmin) {
                loadMenuSections();
            }
        }

        // Verificar sesión de admin
        function checkAdminSession() {
            const adminSession = localStorage.getItem('murritos_admin');
            if (adminSession === 'true') {
                isAdmin = true;
                document.getElementById('userType').textContent = 'Administrador';
                document.getElementById('userType').classList.add('admin');
                document.getElementById('menuTab').style.display = 'flex';
            } else {
                document.getElementById('adminLogin').classList.add('show');
                document.getElementById('menuTab').style.display = 'none';
            }
        }

        // Verificar contraseña de admin
        function checkAdminPassword() {
            const password = document.getElementById('adminPassword').value;
            if (password === 'Tonrry13') {
                isAdmin = true;
                localStorage.setItem('murritos_admin', 'true');
                document.getElementById('adminLogin').classList.remove('show');
                document.getElementById('userType').textContent = 'Administrador';
                document.getElementById('userType').classList.add('admin');
                document.getElementById('menuTab').style.display = 'flex';
                loadMenuSections();
            } else {
                alert('Contraseña incorrecta');
            }
        }

        // Cargar órdenes activas
        function loadActiveOrders() {
            const activeOrdersList = document.getElementById('activeOrdersList');
            activeOrdersList.innerHTML = '<p>Cargando órdenes...</p>';
            
            database.ref('orders').orderByChild('status').equalTo('active').on('value', snapshot => {
                const orders = snapshot.val();
                activeOrdersList.innerHTML = '';
                
                const currentOrderCount = orders ? Object.keys(orders).length : 0;
                
                // Reproducir sonido si hay un nuevo pedido (solo para cocina)
                if (currentUserRole === 'kitchen' && currentOrderCount > lastOrderCount) {
                    playNotificationSound();
                }
                lastOrderCount = currentOrderCount;
                
                if (orders) {
                    Object.entries(orders).forEach(([id, order]) => {
                        const orderCard = document.createElement('div');
                        orderCard.className = 'order-card';
                        orderCard.setAttribute('data-order-id', id);
                        
                        orderCard.innerHTML = `
                            <h4>${order.tableName}</h4>
                            <p>${order.items ? Object.keys(order.items).length : 0} items</p>
                            <p>${formatDate(order.createdAt)}</p>
                            <small class="time-ago">${formatTimeAgo(order.createdAt)}</small>
                            <div class="order-status">
                                <span class="status-badge ${order.preparationStatus || 'pending'}">
                                    ${order.preparationStatus === 'ready' ? 'Listo' : 
                                     order.preparationStatus === 'preparation' ? 'En Preparación' : 'Pendiente'}
                                </span>
                            </div>
                        `;
                        
                        orderCard.addEventListener('click', function() {
                            document.querySelectorAll('.order-card').forEach(card => {
                                card.classList.remove('active');
                            });
                            this.classList.add('active');
                            currentOrderId = id;
                            loadOrderDetails(id);
                        });
                        
                        activeOrdersList.appendChild(orderCard);
                    });
                } else {
                    activeOrdersList.innerHTML = '<p>No hay órdenes activas</p>';
                }
            });
        }

        // Reproducir sonido de notificación
        function playNotificationSound() {
            // Reiniciar el audio para permitir múltiples reproducciones
            newOrderSound.pause();
            newOrderSound.currentTime = 0;
            
            // Intentar reproducir (puede fallar sin interacción del usuario)
            newOrderSound.play().catch(e => {
                console.log("No se pudo reproducir el sonido automáticamente:", e);
                // Mostrar un botón para permitir al usuario activar el sonido
                if (confirm('¿Deseas activar las notificaciones de sonido?')) {
                    newOrderSound.play().catch(e => console.log("El usuario aún no ha permitido el sonido"));
                }
            });
        }

        // Cargar detalles de una orden
        function loadOrderDetails(orderId) {
            const orderDetails = document.getElementById('orderDetails');
            orderDetails.innerHTML = '<p>Cargando detalles...</p>';
            
            database.ref(`orders/${orderId}`).once('value').then(snapshot => {
                const order = snapshot.val();
                
                if (order) {
                    let itemsHtml = '';
                    let total = 0;
                    
                    if (order.items) {
                        Object.entries(order.items).forEach(([id, item]) => {
                            itemsHtml += `
                                <div class="order-item" data-item-id="${id}">
                                    <div class="order-item-info">
                                        <h4>${item.name}</h4>
                                        <p class="order-item-comments">${item.comments || ''}</p>
                                    </div>
                                    <div class="order-item-price">
                                        $${item.price.toFixed(2)} x ${item.quantity} = $${(item.price * item.quantity).toFixed(2)}
                                    </div>
                                </div>
                            `;
                            total += item.price * item.quantity;
                        });
                    }
                    
                    orderDetails.innerHTML = `
                        <div class="order-header">
                            <h3>${order.tableName}</h3>
                            <p>Creada: ${formatDate(order.createdAt)}</p>
                            <p>Estado: 
                                <span class="status-badge ${order.preparationStatus || 'pending'}">
                                    ${order.preparationStatus === 'ready' ? 'Listo' : 
                                     order.preparationStatus === 'preparation' ? 'En Preparación' : 'Pendiente'}
                                </span>
                            </p>
                        </div>
                        
                        <div class="order-items" id="orderItems">
                            ${itemsHtml || '<p>No hay items en esta orden</p>'}
                        </div>
                        
                        <div class="order-total">
                            Total: $${total.toFixed(2)}
                        </div>
                        
                        <div class="order-actions">
                            <button id="addItemBtn" class="btn-primary"><i class="fas fa-plus"></i> Agregar Item</button>
                            ${currentUserRole === 'kitchen' ? `
                            <button id="preparationBtn" class="btn-status ${order.preparationStatus === 'ready' ? 'ready' : 
                                                                          order.preparationStatus === 'preparation' ? 'preparation' : 'pending'}">
                                ${order.preparationStatus === 'ready' ? 'Listo' : 
                                 order.preparationStatus === 'preparation' ? 'En Preparación' : 'Marcar como En Preparación'}
                            </button>
                            ` : ''}
                            <button id="closeOrderBtn" class="btn-primary"><i class="fas fa-check"></i> Cerrar Orden</button>
                        </div>
                    `;
                    
                    // Reasignar event listeners
                    document.getElementById('addItemBtn').addEventListener('click', openAddItemModal);
                    document.getElementById('closeOrderBtn').addEventListener('click', openCloseOrderModal);
                    
                    // Botón de estado de preparación (solo para cocina)
                    if (currentUserRole === 'kitchen') {
                        document.getElementById('preparationBtn').addEventListener('click', function() {
                            const currentStatus = order.preparationStatus || 'pending';
                            let newStatus;
                            
                            if (currentStatus === 'pending') newStatus = 'preparation';
                            else if (currentStatus === 'preparation') newStatus = 'ready';
                            else return;
                            
                            updatePreparationStatus(orderId, newStatus);
                        });
                    }
                    
                    // Agregar evento para eliminar items (doble clic)
                    document.querySelectorAll('.order-item').forEach(item => {
                        item.addEventListener('dblclick', function() {
                            const itemId = this.getAttribute('data-item-id');
                            showConfirmModal(
                                'Eliminar Item', 
                                '¿Estás seguro que deseas eliminar este item de la orden?',
                                () => removeItemFromOrder(orderId, itemId)
                            );
                        });
                    });
                }
            });
        }

        // Actualizar estado de preparación
        function updatePreparationStatus(orderId, status) {
            database.ref(`orders/${orderId}`).update({
                preparationStatus: status
            }).then(() => {
                // Actualizar vista en todas las secciones
                loadOrderDetails(orderId);
                loadActiveOrders();
                loadKitchenOrders();
            }).catch(error => {
                console.error('Error al actualizar estado:', error);
                alert('Hubo un error al actualizar el estado');
            });
        }

        // Cargar órdenes para cocina
        function loadKitchenOrders(filter = 'pending') {
            const kitchenOrders = document.getElementById('kitchenOrders');
            kitchenOrders.innerHTML = '<p>Cargando órdenes...</p>';
            
            database.ref('orders').orderByChild('status').equalTo('active').once('value').then(snapshot => {
                const orders = snapshot.val();
                kitchenOrders.innerHTML = '';
                
                if (orders) {
                    // Convertir a array y ordenar por fecha (más recientes primero)
                    const ordersArray = Object.entries(orders).map(([id, order]) => ({ id, ...order }));
                    ordersArray.sort((a, b) => b.createdAt - a.createdAt);
                    
                    let hasOrders = false;
                    
                    ordersArray.forEach(({ id, ...order }) => {
                        if (filter === 'all' || order.preparationStatus === filter || 
                            (filter === 'pending' && !order.preparationStatus)) {
                            
                            hasOrders = true;
                            const orderCard = document.createElement('div');
                            orderCard.className = `order-card kitchen-card ${order.preparationStatus || 'pending'}`;
                            orderCard.innerHTML = `
                                <div class="order-header">
                                    <h3>${order.tableName}</h3>
                                    <span class="time-ago">${formatTimeAgo(order.createdAt)}</span>
                                </div>
                                <div class="order-items">
                                    ${renderKitchenItems(order.items)}
                                </div>
                                <div class="order-actions">
                                    <button class="btn-status ${order.preparationStatus === 'ready' ? 'ready' : 
                                                              order.preparationStatus === 'preparation' ? 'preparation' : 'pending'}" 
                                        data-order-id="${id}">
                                        ${order.preparationStatus === 'ready' ? 'Listo' : 
                                         order.preparationStatus === 'preparation' ? 'En Preparación' : 'Marcar como En Preparación'}
                                    </button>
                                </div>
                            `;
                            
                            kitchenOrders.appendChild(orderCard);
                            
                            // Event listener para el botón de estado
                            orderCard.querySelector('.btn-status').addEventListener('click', function() {
                                const currentStatus = order.preparationStatus || 'pending';
                                let newStatus;
                                
                                if (currentStatus === 'pending') newStatus = 'preparation';
                                else if (currentStatus === 'preparation') newStatus = 'ready';
                                else return;
                                
                                updatePreparationStatus(id, newStatus);
                            });
                        }
                    });
                    
                    if (!hasOrders) {
                        kitchenOrders.innerHTML = `<p>No hay órdenes ${getFilterName(filter)}</p>`;
                    }
                } else {
                    kitchenOrders.innerHTML = '<p>No hay órdenes activas</p>';
                }
            });
        }

        // Función auxiliar para nombre del filtro
        function getFilterName(filter) {
            switch(filter) {
                case 'pending': return 'pendientes';
                case 'preparation': return 'en preparación';
                case 'ready': return 'listas';
                default: return '';
            }
        }

        // Renderizar items para cocina
        function renderKitchenItems(items) {
            if (!items) return '<p>No hay items en esta orden</p>';
            
            let html = '';
            Object.values(items).forEach(item => {
                html += `
                    <div class="kitchen-item">
                        <span class="item-quantity">${item.quantity}x</span>
                        <span class="item-name">${item.name}</span>
                        ${item.comments ? `<span class="item-comments">${item.comments}</span>` : ''}
                    </div>
                `;
            });
            return html;
        }

        // Cargar datos de ventas
        function loadSalesData() {
            const salesList = document.getElementById('salesList');
            salesList.innerHTML = '<tr><td colspan="5">Cargando ventas...</td></tr>';
            
            let startDate, endDate = new Date();
            endDate.setHours(23, 59, 59, 999);
            
            switch (currentFilter) {
                case 'day':
                    startDate = new Date();
                    startDate.setHours(0, 0, 0, 0);
                    break;
                case 'week':
                    startDate = new Date();
                    startDate.setDate(startDate.getDate() - startDate.getDay());
                    startDate.setHours(0, 0, 0, 0);
                    break;
                case 'month':
                    startDate = new Date();
                    startDate.setDate(1);
                    startDate.setHours(0, 0, 0, 0);
                    break;
            }
            
            database.ref('orders').orderByChild('closedAt').startAt(startDate.getTime()).endAt(endDate.getTime()).once('value').then(snapshot => {
                const orders = snapshot.val();
                salesList.innerHTML = '';
                let totalSales = 0;
                let totalOrders = 0;
                
                if (orders) {
                    // Convertir a array y ordenar por fecha (más recientes primero)
                    const ordersArray = Object.entries(orders).map(([id, order]) => ({ id, ...order }));
                    ordersArray.sort((a, b) => b.closedAt - a.closedAt);
                    
                    ordersArray.forEach(({ id, ...order }) => {
                        if (order.status === 'closed') {
                            totalOrders++;
                            let orderTotal = 0;
                            
                            if (order.items) {
                                Object.values(order.items).forEach(item => {
                                    orderTotal += item.price * item.quantity;
                                });
                            }
                            
                            totalSales += orderTotal;
                            
                            const saleRow = document.createElement('tr');
                            saleRow.innerHTML = `
                                <td>${formatDate(order.closedAt)}</td>
                                <td>${order.tableName}</td>
                                <td>${order.items ? Object.keys(order.items).length : 0}</td>
                                <td>$${orderTotal.toFixed(2)}</td>
                                <td>
                                    <button class="btn-secondary btn-sm view-order" data-order-id="${id}">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    ${isAdmin ? `
                                    <button class="btn-secondary btn-sm delete-order" data-order-id="${id}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    ` : ''}
                                </td>
                            `;
                            
                            salesList.appendChild(saleRow);
                        }
                    });
                    
                    // Agregar event listeners a los botones
                    document.querySelectorAll('.view-order').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const orderId = this.getAttribute('data-order-id');
                            viewClosedOrder(orderId);
                        });
                    });
                    
                    if (isAdmin) {
                        document.querySelectorAll('.delete-order').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const orderId = this.getAttribute('data-order-id');
                                showConfirmModal(
                                    'Eliminar Orden', 
                                    '¿Estás seguro que deseas eliminar permanentemente esta orden?',
                                    () => deleteOrder(orderId)
                                );
                            });
                        });
                    }
                }
                
                if (totalOrders === 0) {
                    salesList.innerHTML = '<tr><td colspan="5">No hay ventas registradas</td></tr>';
                }
                
                // Actualizar resumen
                document.getElementById('totalSales').textContent = `$${totalSales.toFixed(2)}`;
                document.getElementById('totalOrders').textContent = totalOrders;
            });
        }

        // Cargar secciones del menú
        function loadMenuSections() {
            if (!isAdmin) return;
            
            const menuSections = document.getElementById('menuSections');
            menuSections.innerHTML = '<p>Cargando menú...</p>';
            
            database.ref('menuSections').on('value', snapshot => {
                const sections = snapshot.val();
                menuSections.innerHTML = '';
                
                if (sections) {
                    Object.entries(sections).forEach(([id, section]) => {
                        const sectionDiv = document.createElement('div');
                        sectionDiv.className = 'menu-section';
                        sectionDiv.setAttribute('data-section-id', id);
                        
                        let itemsHtml = '';
                        
                        if (section.items) {
                            Object.entries(section.items).forEach(([itemId, item]) => {
                                itemsHtml += `
                                    <div class="menu-item" data-item-id="${itemId}">
                                        <h4>${item.name}</h4>
                                        <p>$${item.price.toFixed(2)}</p>
                                        <div class="item-actions">
                                            <button class="btn-secondary btn-sm edit-item">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn-secondary btn-sm delete-item">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                `;
                            });
                        }
                        
                        sectionDiv.innerHTML = `
                            <div class="section-header">
                                <h3>${section.name}</h3>
                                <div class="section-actions">
                                    <button class="btn-primary btn-sm add-item">
                                        <i class="fas fa-plus"></i> Item
                                    </button>
                                    <button class="btn-secondary btn-sm edit-section">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn-secondary btn-sm delete-section">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="menu-items">
                                ${itemsHtml || '<p>No hay items en esta sección</p>'}
                            </div>
                        `;
                        
                        // Agregar event listeners
                        sectionDiv.querySelector('.add-item').addEventListener('click', () => {
                            currentSectionId = id;
                            currentItemId = null;
                            document.getElementById('itemModalTitle').textContent = 'Nuevo Item';
                            document.getElementById('itemName').value = '';
                            document.getElementById('itemPrice').value = '';
                            document.getElementById('itemModal').classList.add('show');
                        });
                        
                        sectionDiv.querySelector('.edit-section').addEventListener('click', () => {
                            currentSectionId = id;
                            document.getElementById('sectionModalTitle').textContent = 'Editar Sección';
                            document.getElementById('sectionName').value = section.name;
                            document.getElementById('sectionModal').classList.add('show');
                        });
                        
                        sectionDiv.querySelector('.delete-section').addEventListener('click', () => {
                            showConfirmModal(
                                'Eliminar Sección', 
                                '¿Estás seguro que deseas eliminar esta sección y todos sus items?',
                                () => deleteMenuSection(id)
                            );
                        });
                        
                        // Event listeners para items
                        sectionDiv.querySelectorAll('.edit-item').forEach((btn, index) => {
                            btn.addEventListener('click', () => {
                                const itemId = sectionDiv.querySelectorAll('.menu-item')[index].getAttribute('data-item-id');
                                const item = section.items[itemId];
                                
                                currentSectionId = id;
                                currentItemId = itemId;
                                
                                document.getElementById('itemModalTitle').textContent = 'Editar Item';
                                document.getElementById('itemName').value = item.name;
                                document.getElementById('itemPrice').value = item.price;
                                document.getElementById('itemModal').classList.add('show');
                            });
                        });
                        
                        sectionDiv.querySelectorAll('.delete-item').forEach((btn, index) => {
                            btn.addEventListener('click', () => {
                                const itemId = sectionDiv.querySelectorAll('.menu-item')[index].getAttribute('data-item-id');
                                
                                showConfirmModal(
                                    'Eliminar Item', 
                                    '¿Estás seguro que deseas eliminar este item del menú?',
                                    () => deleteMenuItem(id, itemId)
                                );
                            });
                        });
                        
                        menuSections.appendChild(sectionDiv);
                    });
                } else {
                    menuSections.innerHTML = '<p>No hay secciones en el menú</p>';
                }
            });
        }

        // Abrir modal de nueva orden
        function openNewOrderModal() {
            document.getElementById('tableName').value = '';
            document.getElementById('newOrderModal').classList.add('show');
        }

        // Crear nueva orden
        function createNewOrder() {
            const tableName = document.getElementById('tableName').value.trim();
            
            if (!tableName) {
                alert('Por favor ingresa un nombre para la mesa');
                return;
            }
            
            const newOrder = {
                tableName,
                status: 'active',
                preparationStatus: 'pending',
                createdAt: Date.now(),
                items: {}
            };
            
            const newOrderRef = database.ref('orders').push();
            newOrderRef.set(newOrder)
                .then(() => {
                    document.getElementById('newOrderModal').classList.remove('show');
                    currentOrderId = newOrderRef.key;
                    loadOrderDetails(currentOrderId);
                    loadKitchenOrders();
                    
                    // Marcar como activa en la lista
                    setTimeout(() => {
                        const orderCard = document.querySelector(`.order-card[data-order-id="${currentOrderId}"]`);
                        if (orderCard) {
                            orderCard.click();
                        }
                    }, 500);
                })
                .catch(error => {
                    console.error('Error al crear orden:', error);
                    alert('Hubo un error al crear la orden');
                });
        }

        // Abrir modal para agregar item
        function openAddItemModal() {
            if (!currentOrderId) return;
            
            // Limpiar selects
            const itemSectionSelect = document.getElementById('itemSection');
            const itemSelect = document.getElementById('itemSelect');
            itemSectionSelect.innerHTML = '<option value="">Cargando secciones...</option>';
            itemSelect.innerHTML = '<option value="">Selecciona una sección primero</option>';
            
            // Cargar secciones
            database.ref('menuSections').once('value').then(snapshot => {
                const sections = snapshot.val();
                itemSectionSelect.innerHTML = '<option value="">Selecciona una sección</option>';
                
                if (sections) {
                    Object.entries(sections).forEach(([id, section]) => {
                        const option = document.createElement('option');
                        option.value = id;
                        option.textContent = section.name;
                        itemSectionSelect.appendChild(option);
                    });
                }
            });
            
            // Resetear otros campos
            document.getElementById('itemQuantity').value = '1';
            document.getElementById('itemComments').value = '';
            
            // Mostrar modal
            document.getElementById('addItemModal').classList.add('show');
            
            // Event listener para cambio de sección
            itemSectionSelect.addEventListener('change', function() {
                const sectionId = this.value;
                itemSelect.innerHTML = '<option value="">Cargando items...</option>';
                
                if (sectionId) {
                    database.ref(`menuSections/${sectionId}/items`).once('value').then(snapshot => {
                        const items = snapshot.val();
                        itemSelect.innerHTML = '<option value="">Selecciona un item</option>';
                        
                        if (items) {
                            Object.entries(items).forEach(([id, item]) => {
                                const option = document.createElement('option');
                                option.value = id;
                                option.textContent = `${item.name} - $${item.price.toFixed(2)}`;
                                option.setAttribute('data-price', item.price);
                                itemSelect.appendChild(option);
                            });
                        }
                    });
                } else {
                    itemSelect.innerHTML = '<option value="">Selecciona una sección primero</option>';
                }
            });
        }

        // Agregar item a la orden
        function addItemToOrder() {
            if (!currentOrderId) return;
            
            const sectionId = document.getElementById('itemSection').value;
            const itemId = document.getElementById('itemSelect').value;
            const quantity = parseInt(document.getElementById('itemQuantity').value);
            const comments = document.getElementById('itemComments').value.trim();
            
            if (!sectionId || !itemId || !quantity || quantity < 1) {
                alert('Por favor completa todos los campos requeridos');
                return;
            }
            
            // Obtener información del item
            database.ref(`menuSections/${sectionId}/items/${itemId}`).once('value').then(snapshot => {
                const item = snapshot.val();
                
                if (item) {
                    const newItem = {
                        sectionId,
                        sectionName: document.getElementById('itemSection').options[document.getElementById('itemSection').selectedIndex].text,
                        itemId,
                        name: item.name,
                        price: item.price,
                        quantity,
                        comments
                    };
                    
                    // Agregar a la orden
                    database.ref(`orders/${currentOrderId}/items`).push(newItem)
                        .then(() => {
                            document.getElementById('addItemModal').classList.remove('show');
                            loadOrderDetails(currentOrderId);
                            loadKitchenOrders();
                        })
                        .catch(error => {
                            console.error('Error al agregar item:', error);
                            alert('Hubo un error al agregar el item');
                        });
                }
            });
        }

        // Remover item de la orden
        function removeItemFromOrder(orderId, itemId) {
            database.ref(`orders/${orderId}/items/${itemId}`).remove()
                .then(() => {
                    loadOrderDetails(orderId);
                    loadKitchenOrders();
                })
                .catch(error => {
                    console.error('Error al eliminar item:', error);
                    alert('Hubo un error al eliminar el item');
                });
        }

        // Abrir modal para cerrar orden
        function openCloseOrderModal() {
            if (!currentOrderId) return;
            
            const orderSummary = document.getElementById('closeOrderSummary');
            orderSummary.innerHTML = '<p>Cargando resumen...</p>';
            
            database.ref(`orders/${currentOrderId}`).once('value').then(snapshot => {
                const order = snapshot.val();
                
                if (order) {
                    let itemsHtml = '';
                    let total = 0;
                    
                    if (order.items) {
                        Object.entries(order.items).forEach(([id, item]) => {
                            itemsHtml += `
                                <div class="order-item" data-item-id="${id}">
                                    <div class="order-item-info">
                                        <h4>${item.name}</h4>
                                        <p class="order-item-comments">${item.comments || ''}</p>
                                    </div>
                                    <div class="order-item-price">
                                        $${item.price.toFixed(2)} x ${item.quantity} = $${(item.price * item.quantity).toFixed(2)}
                                    </div>
                                </div>
                            `;
                            total += item.price * item.quantity;
                        });
                    }
                    
                    orderSummary.innerHTML = `
                        <h3>${order.tableName}</h3>
                        <p>Fecha: ${formatDate(order.createdAt)}</p>
                        <p>Estado: 
                            <span class="status-badge ${order.preparationStatus || 'pending'}">
                                ${order.preparationStatus === 'ready' ? 'Listo' : 
                                 order.preparationStatus === 'preparation' ? 'En Preparación' : 'Pendiente'}
                            </span>
                        </p>
                        <div class="order-items">
                            ${itemsHtml || '<p>No hay items en esta orden</p>'}
                        </div>
                        <div class="order-total">
                            Total: $${total.toFixed(2)}
                        </div>
                    `;
                    
                    document.getElementById('finalComments').value = '';
                    document.getElementById('closeOrderModal').classList.add('show');
                }
            });
        }

        // Cerrar orden
        function closeOrder() {
            if (!currentOrderId) return;
            
            const finalComments = document.getElementById('finalComments').value.trim();
            
            database.ref(`orders/${currentOrderId}`).update({
                status: 'closed',
                closedAt: Date.now(),
                finalComments
            })
            .then(() => {
                document.getElementById('closeOrderModal').classList.remove('show');
                
                // Obtener datos completos de la orden para imprimir
                database.ref(`orders/${currentOrderId}`).once('value').then(snapshot => {
                    const order = snapshot.val();
                    if (order) {
                        // Preparar datos para el ticket
                        const ticketData = {
                            numero_orden: currentOrderId,
                            mesa: order.tableName,
                            mesero: "Mesero Principal", // Puedes ajustar esto según tu sistema
                            items: [],
                            subtotal: 0,
                            iva: 0,
                            total: 0,
                            fecha: formatDate(order.closedAt)
                        };
                        
                        // Calcular totales
                        if (order.items) {
                            Object.values(order.items).forEach(item => {
                                ticketData.items.push({
                                    nombre: item.name,
                                    cantidad: item.quantity,
                                    precio: item.price
                                });
                                ticketData.subtotal += item.price * item.quantity;
                            });
                        }
                        
                        // Calcular IVA (16%)
                        ticketData.iva = ticketData.subtotal * 0.16;
                        ticketData.total = ticketData.subtotal + ticketData.iva;
                        
                        // Imprimir ticket
                        imprimirTicket(ticketData);
                    }
                });
                
                currentOrderId = null;
                loadActiveOrders();
                loadSalesData();
                loadKitchenOrders();
                
                // Limpiar detalles de orden
                document.getElementById('orderDetails').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-clipboard-list"></i>
                        <p>Selecciona una orden o crea una nueva</p>
                    </div>
                `;
            })
            .catch(error => {
                console.error('Error al cerrar orden:', error);
                alert('Hubo un error al cerrar la orden');
            });
        }

        // Función para imprimir ticket
        function imprimirTicket(orden_data) {
            console.log("Iniciando impresión del ticket...");
            
            // Crear contenido del ticket
            let ticketContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="utf-8">
                    <title>Ticket de Venta</title>
                    <style>
                        body {
                            font-family: 'Courier New', monospace;
                            width: 48mm;
                            margin: 0;
                            padding: 5px;
                            font-size: 12px;
                        }
                        .ticket {
                            width: 100%;
                            max-width: 48mm;
                        }
                        .header {
                            text-align: center;
                            margin-bottom: 10px;
                        }
                        .restaurant-name {
                            font-weight: bold;
                            font-size: 16px;
                            margin-bottom: 5px;
                        }
                        .separator {
                            border-top: 1px dashed #000;
                            margin: 8px 0;
                        }
                        .info-line {
                            display: flex;
                            justify-content: space-between;
                            margin: 3px 0;
                        }
                        .items-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 8px 0;
                        }
                        .items-table th {
                            text-align: left;
                            border-bottom: 1px solid #000;
                            padding: 3px 0;
                        }
                        .items-table td {
                            padding: 2px 0;
                        }
                        .total {
                            font-weight: bold;
                            font-size: 14px;
                            text-align: right;
                            margin-top: 8px;
                        }
                        .footer {
                            text-align: center;
                            margin-top: 15px;
                            font-size: 10px;
                        }
                        .text-center {
                            text-align: center;
                        }
                        .text-right {
                            text-align: right;
                        }
                    </style>
                </head>
                <body>
                    <div class="ticket">
                        <div class="header">
                            <div class="restaurant-name">MURRITOS</div>
                            <div>Ticket de Venta</div>
                        </div>
                        
                        <div class="separator"></div>
                        
                        <div class="info-line">
                            <span>Orden:</span>
                            <span>#${orden_data.numero_orden}</span>
                        </div>
                        <div class="info-line">
                            <span>Fecha:</span>
                            <span>${orden_data.fecha}</span>
                        </div>
                        <div class="info-line">
                            <span>Mesa:</span>
                            <span>${orden_data.mesa}</span>
                        </div>
                        <div class="info-line">
                            <span>Mesero:</span>
                            <span>${orden_data.mesero}</span>
                        </div>
                        
                        <div class="separator"></div>
                        
                        <table class="items-table">
                            <thead>
                                <tr>
                                    <th>CANT</th>
                                    <th>DESCRIPCIÓN</th>
                                    <th class="text-right">PRECIO</th>
                                </tr>
                            </thead>
                            <tbody>`;
            
            // Agregar items
            orden_data.items.forEach(item => {
                const nombre = item.nombre.length > 16 ? item.nombre.substring(0, 16) + "..." : item.nombre;
                ticketContent += `
                    <tr>
                        <td>${item.cantidad}</td>
                        <td>${nombre}</td>
                        <td class="text-right">$${(item.precio * item.cantidad).toFixed(2)}</td>
                    </tr>`;
            });
            
            // Agregar totales
            ticketContent += `
                            </tbody>
                        </table>
                        
                        <div class="separator"></div>
                        
                        <div class="info-line">
                            <span>Subtotal:</span>
                            <span>$${orden_data.subtotal.toFixed(2)}</span>
                        </div>
                        <div class="info-line">
                            <span>IVA (16%):</span>
                            <span>$${orden_data.iva.toFixed(2)}</span>
                        </div>
                        <div class="total">
                            TOTAL: $${orden_data.total.toFixed(2)}
                        </div>
                        
                        <div class="separator"></div>
                        
                        <div class="footer">
                            <div>¡Gracias por su visita!</div>
                            <div>${new Date().getFullYear()} © Murritos</div>
                        </div>
                    </div>
                </body>
                </html>
            `;
            
            // Intentar imprimir
            try {
                const ventana = window.open('', '_blank', 'width=200,height=500');
                ventana.document.write(ticketContent);
                ventana.document.close();
                
                // Esperar a que se cargue el contenido antes de imprimir
                setTimeout(() => {
                    ventana.print();
                    setTimeout(() => {
                        ventana.close();
                    }, 500);
                }, 500);
                
                console.log("Ticket enviado a impresión");
            } catch (error) {
                console.error("Error al imprimir:", error);
                alert("No se pudo imprimir el ticket. Error: " + error.message);
            }
        }

        // Ver orden cerrada
        function viewClosedOrder(orderId) {
            const orderDetails = document.getElementById('orderDetails');
            orderDetails.innerHTML = '<p>Cargando detalles...</p>';
            
            database.ref(`orders/${orderId}`).once('value').then(snapshot => {
                const order = snapshot.val();
                
                if (order) {
                    let itemsHtml = '';
                    let total = 0;
                    
                    if (order.items) {
                        Object.entries(order.items).forEach(([id, item]) => {
                            itemsHtml += `
                                <div class="order-item">
                                    <div class="order-item-info">
                                        <h4>${item.name}</h4>
                                        <p class="order-item-comments">${item.comments || ''}</p>
                                    </div>
                                    <div class="order-item-price">
                                        $${item.price.toFixed(2)} x ${item.quantity} = $${(item.price * item.quantity).toFixed(2)}
                                    </div>
                                </div>
                            `;
                            total += item.price * item.quantity;
                        });
                    }
                    
                    orderDetails.innerHTML = `
                        <div class="order-header">
                            <h3>${order.tableName}</h3>
                            <p>Cerrada: ${formatDate(order.closedAt)}</p>
                            ${order.finalComments ? `<p class="final-comments">Comentarios: ${order.finalComments}</p>` : ''}
                        </div>
                        
                        <div class="order-items">
                            ${itemsHtml || '<p>No hay items en esta orden</p>'}
                        </div>
                        
                        <div class="order-total">
                            Total: $${total.toFixed(2)}
                        </div>
                        
                        <div class="order-actions">
                            <button id="backToSalesBtn" class="btn-primary"><i class="fas fa-arrow-left"></i> Volver a Ventas</button>
                        </div>
                    `;
                    
                    document.getElementById('backToSalesBtn').addEventListener('click', () => {
                        document.querySelector('nav ul li[data-section="sales"]').click();
                    });
                }
            });
        }

        // Eliminar orden
        function deleteOrder(orderId) {
            database.ref(`orders/${orderId}`).remove()
                .then(() => {
                    loadSalesData();
                })
                .catch(error => {
                    console.error('Error al eliminar orden:', error);
                    alert('Hubo un error al eliminar la orden');
                });
        }

        // Abrir modal de sección
        function openSectionModal() {
            currentSectionId = null;
            document.getElementById('sectionModalTitle').textContent = 'Nueva Sección';
            document.getElementById('sectionName').value = '';
            document.getElementById('sectionModal').classList.add('show');
        }

        // Guardar sección
        function saveSection() {
            const sectionName = document.getElementById('sectionName').value.trim();
            
            if (!sectionName) {
                alert('Por favor ingresa un nombre para la sección');
                return;
            }
            
            if (currentSectionId) {
                // Editar sección existente
                database.ref(`menuSections/${currentSectionId}`).update({
                    name: sectionName
                })
                .then(() => {
                    document.getElementById('sectionModal').classList.remove('show');
                })
                .catch(error => {
                    console.error('Error al editar sección:', error);
                    alert('Hubo un error al editar la sección');
                });
            } else {
                // Crear nueva sección
                const newSection = {
                    name: sectionName,
                    items: {}
                };
                
                database.ref('menuSections').push(newSection)
                    .then(() => {
                        document.getElementById('sectionModal').classList.remove('show');
                    })
                    .catch(error => {
                        console.error('Error al crear sección:', error);
                        alert('Hubo un error al crear la sección');
                    });
            }
        }

        // Eliminar sección del menú
        function deleteMenuSection(sectionId) {
            database.ref(`menuSections/${sectionId}`).remove()
                .then(() => {
                    loadMenuSections();
                })
                .catch(error => {
                    console.error('Error al eliminar sección:', error);
                    alert('Hubo un error al eliminar la sección');
                });
        }

        // Guardar item
        function saveItem() {
            const itemName = document.getElementById('itemName').value.trim();
            const itemPrice = parseFloat(document.getElementById('itemPrice').value);
            
            if (!itemName || isNaN(itemPrice)) {
                alert('Por favor completa todos los campos requeridos');
                return;
            }
            
            if (!currentSectionId) {
                alert('No se ha seleccionado una sección');
                return;
            }
            
            const newItem = {
                name: itemName,
                price: itemPrice
            };
            
            if (currentItemId) {
                // Editar item existente
                database.ref(`menuSections/${currentSectionId}/items/${currentItemId}`).update(newItem)
                    .then(() => {
                        document.getElementById('itemModal').classList.remove('show');
                    })
                    .catch(error => {
                        console.error('Error al editar item:', error);
                        alert('Hubo un error al editar el item');
                    });
            } else {
                // Crear nuevo item
                database.ref(`menuSections/${currentSectionId}/items`).push(newItem)
                    .then(() => {
                        document.getElementById('itemModal').classList.remove('show');
                    })
                    .catch(error => {
                        console.error('Error al crear item:', error);
                        alert('Hubo un error al crear el item');
                    });
            }
        }

        // Eliminar item del menú
        function deleteMenuItem(sectionId, itemId) {
            database.ref(`menuSections/${sectionId}/items/${itemId}`).remove()
                .then(() => {
                    loadMenuSections();
                })
                .catch(error => {
                    console.error('Error al eliminar item:', error);
                    alert('Hubo un error al eliminar el item');
                });
        }

        // Mostrar modal de confirmación
        function showConfirmModal(title, message, confirmCallback) {
            document.getElementById('confirmModalTitle').textContent = title;
            document.getElementById('confirmModalMessage').textContent = message;
            document.getElementById('confirmModal').classList.add('show');
            
            // Limpiar event listeners anteriores
            const confirmBtn = document.getElementById('confirmModalConfirm');
            const cancelBtn = document.getElementById('confirmModalCancel');
            
            confirmBtn.replaceWith(confirmBtn.cloneNode(true));
            cancelBtn.replaceWith(cancelBtn.cloneNode(true));
            
            // Asignar nuevos event listeners
            document.getElementById('confirmModalConfirm').addEventListener('click', () => {
                confirmCallback();
                document.getElementById('confirmModal').classList.remove('show');
            });
            
            document.getElementById('confirmModalCancel').addEventListener('click', () => {
                document.getElementById('confirmModal').classList.remove('show');
            });
        }

        // Formatear fecha
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleDateString('es-MX', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Formatear tiempo transcurrido
        function formatTimeAgo(timestamp) {
            const seconds = Math.floor((Date.now() - timestamp) / 1000);
            
            if (seconds < 60) return 'Hace unos segundos';
            if (seconds < 120) return 'Hace 1 minuto';
            if (seconds < 3600) return `Hace ${Math.floor(seconds/60)} minutos`;
            if (seconds < 7200) return 'Hace 1 hora';
            if (seconds < 86400) return `Hace ${Math.floor(seconds/3600)} horas`;
            if (seconds < 172800) return 'Ayer';
            
            return formatDate(timestamp);
        }
    </script>
</body>
</html>
